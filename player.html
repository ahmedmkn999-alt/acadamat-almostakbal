<!DOCTYPE html>
<html lang="ar" dir="rtl" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Full Mark | مشاهدة الفيديو</title>

    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js"></script>
    
    <script type="module" src="devcheck.js"></script>
    <script src="auth.js"></script>

    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
    <script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

    <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: '#08402C',
            secondary: '#00F5C4',
            dark: '#020A07',
            card: '#0C241C',
          },
          fontFamily: { sans: ['Tajawal', 'sans-serif'] }
        }
      }
    }
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        body { 
            font-family: 'Tajawal', sans-serif; 
            background-color: #020A07; 
            color: #E6F0E8; 
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        
        .glass-panel {
            background: rgba(12, 36, 28, 0.9);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(0, 245, 196, 0.1);
        }

        /* تخصيص مشغل الفيديو */
        .plyr {
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(0, 245, 196, 0.2);
            --plyr-color-main: #00F5C4;
        }

        /* طبقة حماية ضد التصوير (Watermark) */
        .watermark {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            color: rgba(255, 255, 255, 0.1);
            font-size: 2rem;
            font-weight: bold;
            pointer-events: none;
            z-index: 10;
            user-select: none;
            white-space: nowrap;
            animation: float 10s infinite linear;
        }

        @keyframes float {
            0% { transform: translate(-50%, -50%) rotate(-10deg); }
            50% { transform: translate(-40%, -40%) rotate(10deg); }
            100% { transform: translate(-50%, -50%) rotate(-10deg); }
        }
    </style>
</head>

<body class="overflow-hidden">

    <header class="glass-panel h-16 flex items-center justify-between px-4 z-20 shadow-lg shrink-0">
        <div class="flex items-center gap-3">
            <button onclick="history.back()" class="w-9 h-9 rounded-full bg-primary/30 flex items-center justify-center text-secondary hover:bg-secondary hover:text-black transition-all">
                <i class="ph ph-arrow-right text-lg font-bold"></i>
            </button>
            <h1 class="text-lg font-bold text-white leading-tight truncate max-w-[200px]" id="videoTitle">جاري التحميل...</h1>
        </div>
        
        <div class="w-9 h-9 rounded-full bg-gradient-to-br from-secondary to-primary flex items-center justify-center shadow-lg shadow-secondary/10">
            <i class="ph ph-video text-black text-xl"></i>
        </div>
    </header>

    <main class="flex-1 flex flex-col items-center justify-center p-4 w-full max-w-5xl mx-auto">
        <div class="w-full relative group">
            
            <video id="player" playsinline controls class="w-full aspect-video bg-black rounded-xl">
                </video>

            <div id="watermark" class="watermark"></div>

        </div>

        <p class="mt-4 text-gray-400 text-sm text-center">
            <i class="ph ph-info text-secondary"></i>
            اسحب لليمين/اليسار للتقديم والتأخير
        </p>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const videoSource = localStorage.getItem('video_source');
            const videoTitle = localStorage.getItem('video_title') || 'محاضرة تعليمية';
            const studentCode = localStorage.getItem('activeCode') || 'Full Mark';

            // 1. تحديث العنوان والعلامة المائية
            document.getElementById('videoTitle').textContent = videoTitle;
            document.getElementById('watermark').textContent = studentCode;

            const video = document.getElementById('player');

            // 2. التحقق من وجود رابط
            if (!videoSource) {
                alert("عفواً، لا يوجد فيديو للتشغيل.");
                history.back();
                return;
            }

            // 3. تشغيل HLS (لصيغة .m3u8)
            if (Hls.isSupported() && videoSource.includes('.m3u8')) {
                const hls = new Hls();
                hls.loadSource(videoSource);
                hls.attachMedia(video);
                
                hls.on(Hls.Events.MANIFEST_PARSED, function() {
                    // Plyr setup after HLS is ready
                    new Plyr(video, {
                        controls: ['play-large', 'play', 'progress', 'current-time', 'mute', 'volume', 'settings', 'fullscreen'],
                        settings: ['speed']
                    });
                });
            } else {
                // Fallback for standard video or native HLS (Safari)
                video.src = videoSource;
                new Plyr(video, {
                    controls: ['play-large', 'play', 'progress', 'current-time', 'mute', 'volume', 'settings', 'fullscreen'],
                    settings: ['speed']
                });
            }

            // 4. حماية الفيديو (منع كليك يمين)
            document.addEventListener('contextmenu', event => event.preventDefault());
        });
    </script>

</body>
</html>

