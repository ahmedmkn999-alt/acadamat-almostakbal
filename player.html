<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مشاهدة الفيديو</title>
    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background: #000; margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        .video-container { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; position: relative; }
        
        /* تأثير الضغطتين (Animate) */
        .tap-indicator {
            position: absolute; top: 50%; transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.2); border-radius: 50%;
            width: 80px; height: 80px; display: flex; align-items: center; justify-content: center;
            color: white; font-size: 20px; opacity: 0; pointer-events: none; transition: 0.2s;
        }
        .tap-left { left: 10%; }
        .tap-right { right: 10%; }
        .show-tap { opacity: 1; transform: translateY(-50%) scale(1.2); }

        /* زر الإغلاق */
        .close-btn {
            position: absolute; top: 20px; right: 20px; z-index: 50;
            background: rgba(0,0,0,0.5); color: white; width: 40px; height: 40px;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 20px; cursor: pointer; border: 1px solid rgba(255,255,255,0.2);
        }
    </style>
</head>
<body>
    <div onclick="history.back()" class="close-btn">✕</div>

    <div class="video-container" id="videoWrapper">
        <video id="player" playsinline controls data-poster="https://via.placeholder.com/1920x1080?text=FullMark+Player"></video>
        
        <div id="tapLeft" class="tap-indicator tap-left">10s ⏪</div>
        <div id="tapRight" class="tap-indicator tap-right">⏩ 10s</div>
    </div>

    <script src="https://cdn.plyr.io/3.7.8/plyr.js"></script>
    <script>
        const videoData = JSON.parse(localStorage.getItem('currentVideo'));
        const videoElement = document.getElementById('player');
        
        if (videoData) {
            let url = videoData.stream_url || videoData.link || videoData.url || videoData.video_url;

            // لو الفيديو يوتيوب
            if (url.includes('youtube') || url.includes('youtu.be')) {
                // استبدال المشغل بـ Iframe لليوتيوب عشان يدعم مميزات Plyr
                document.getElementById('videoWrapper').innerHTML = `
                    <div id="player" data-plyr-provider="youtube" data-plyr-embed-id="${url}"></div>
                    <div id="tapLeft" class="tap-indicator tap-left">10s ⏪</div>
                    <div id="tapRight" class="tap-indicator tap-right">⏩ 10s</div>
                `;
            } else {
                // لو فيديو مباشر (MP4)
                videoElement.src = url;
            }

            // تشغيل المشغل الاحترافي
            const player = new Plyr('#player', {
                controls: ['play-large', 'play', 'progress', 'current-time', 'mute', 'volume', 'captions', 'settings', 'pip', 'airplay', 'fullscreen'],
                settings: ['captions', 'quality', 'speed'],
                speed: { selected: 1, options: [0.5, 0.75, 1, 1.25, 1.5, 2] }
            });

            // ⚡ كود اللمس المزدوج (Double Tap)
            let lastTapTime = 0;
            const wrapper = document.getElementById('videoWrapper');

            wrapper.addEventListener('click', (e) => {
                const currentTime = new Date().getTime();
                const tapLength = currentTime - lastTapTime;
                
                // لو الفرق بين الضغطتين أقل من 300 ملي ثانية (يعني ضغطتين ورا بعض)
                if (tapLength < 300 && tapLength > 0) {
                    const screenWidth = wrapper.offsetWidth;
                    const tapX = e.clientX;

                    if (tapX > screenWidth / 2) {
                        // يمين الشاشة -> تقديم
                        player.forward(10);
                        showTapEffect('tapRight');
                    } else {
                        // يسار الشاشة -> ترجيع
                        player.rewind(10);
                        showTapEffect('tapLeft');
                    }
                    e.preventDefault(); // منع الإيقاف المؤقت عند الدبل كليك
                }
                lastTapTime = currentTime;
            });

            function showTapEffect(id) {
                const el = document.getElementById(id);
                el.classList.add('show-tap');
                setTimeout(() => el.classList.remove('show-tap'), 500);
            }

        } else {
            alert('لا يوجد فيديو لعرضه!');
            history.back();
        }
    </script>
</body>
</html>
