<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>المواد</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="auth.js"></script>
    <style>body { background: #020617; color: white; font-family: sans-serif; padding-bottom: 50px; }</style>
</head>
<body class="p-6">
    <div id="app">
        <div class="flex justify-between items-center mb-8 bg-slate-900 p-4 rounded-xl border border-slate-700">
            <div>
                <h2 id="studentName" class="text-lg font-bold text-white">طالب مجتهد</h2>
                <p class="text-xs text-yellow-500">مرحباً بك في منصتك</p>
            </div>
            <a href="timer.html" class="w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center text-white"><i class="fas fa-user"></i></a>
        </div>

        <h3 class="text-xl font-bold mb-6 border-r-4 border-yellow-500 pr-3">المواد المتاحة</h3>

        <div v-if="loading" class="text-center mt-20">جاري التحميل...</div>
        
        <div v-else class="grid grid-cols-2 gap-4">
            <div v-for="sub in subjects" :key="sub.id" @click="openSub(sub)" class="bg-slate-800 rounded-xl overflow-hidden cursor-pointer hover:border-yellow-500 border border-transparent transition">
                <div class="h-32 bg-slate-700 relative">
                    <img :src="getImg(sub.name)" class="w-full h-full object-cover" onerror="this.src='https://via.placeholder.com/300x200/1e293b/ffffff?text=Subject'">
                    <div class="absolute bottom-0 w-full bg-black/60 p-2 text-center text-sm font-bold truncate">{{ sub.name }}</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, onMounted } = Vue;

        // روابط صور بديلة قوية
        const IMGS = {
            "عرب": "https://cdn-icons-png.flaticon.com/512/330/330459.png", 
            "نجليز": "https://cdn-icons-png.flaticon.com/512/3269/3269817.png",
            "فيزيا": "https://cdn-icons-png.flaticon.com/512/3081/3081530.png",
            "كيميا": "https://cdn-icons-png.flaticon.com/512/1048/1048953.png",
            "أحيا": "https://cdn-icons-png.flaticon.com/512/2997/2997300.png",
            "رياض": "https://cdn-icons-png.flaticon.com/512/3771/3771278.png",
            "تاريخ": "https://cdn-icons-png.flaticon.com/512/2234/2234665.png",
            "default": "https://cdn-icons-png.flaticon.com/512/2997/2997300.png"
        };

        const URLS = {
            'علمي علوم': "https://plus-teal.vercel.app/organized_output.json",
            'أدبي': "https://plus-teal.vercel.app/organized_output-a.json", 
            'علمي رياضة': "https://platform-sigma-seven.vercel.app/organized_output-e.json",
            'أزهر': "https://plus-teal.vercel.app/organized_output.json"
        };

        createApp({
            setup() {
                const subjects = ref([]);
                const loading = ref(true);
                const yid = ref(null);

                const getImg = (n) => {
                    for(let k in IMGS) if(n.includes(k)) return IMGS[k];
                    return IMGS['default'];
                };
                
                const openSub = (s) => window.location.href = `chapters.html?yid=${yid.value}&sid=${s.id}`;
                
                onMounted(async () => {
                    const code = localStorage.getItem('activeCode');
                    const db = firebase.database();
                    const snap = await db.ref('approvedStudents/' + code).once('value');
                    const student = snap.val();
                    
                    if(student) document.getElementById('studentName').innerText = student.studentName;
                    
                    try {
                        const res = await fetch(URLS[student.section.trim()]);
                        const data = await res.json();
                        let year = data.find(y => y.name.includes('3') || y.id == 3) || data[0];
                        yid.value = year.id;
                        subjects.value = year.subjects || [];
                    } catch(e) {}
                    loading.value = false;
                });
                return { subjects, loading, getImg, openSub };
            }
        }).mount('#app');
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</body>
</html>
