<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Dashboard | Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background: #0f172a; font-family: sans-serif; color: #e2e8f0; }
        .glass-panel { background: #1e293b; border: 1px solid #334155; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .stat-card { background: linear-gradient(135deg, #1e293b, #0f172a); border: 1px solid #334155; }
        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #3b82f6; border-radius: 4px; }
    </style>
</head>
<body class="p-6">

    <div class="max-w-7xl mx-auto mb-8">
        <h1 class="text-3xl font-bold text-yellow-400 mb-6 flex items-center gap-3">
            <i class="fas fa-chart-line"></i> Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©
        </h1>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="stat-card p-6 rounded-2xl relative overflow-hidden">
                <div class="absolute top-0 left-0 p-4 opacity-10"><i class="fas fa-users text-8xl text-blue-500"></i></div>
                <h3 class="text-gray-400 font-bold">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†</h3>
                <p id="totalStudents" class="text-4xl font-bold text-white mt-2">0</p>
            </div>
            <div class="stat-card p-6 rounded-2xl relative overflow-hidden border-green-900/50">
                <div class="absolute top-0 left-0 p-4 opacity-10"><i class="fas fa-money-bill-wave text-8xl text-green-500"></i></div>
                <h3 class="text-gray-400 font-bold">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­</h3>
                <p id="totalRevenue" class="text-4xl font-bold text-green-400 mt-2">0 <span class="text-sm">EGP</span></p>
            </div>
            <div class="stat-card p-6 rounded-2xl relative overflow-hidden">
                <div class="absolute top-0 left-0 p-4 opacity-10"><i class="fas fa-check-circle text-8xl text-yellow-500"></i></div>
                <h3 class="text-gray-400 font-bold">Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù…Ø¨Ø§Ø¹Ø©</h3>
                <p id="soldCodes" class="text-4xl font-bold text-yellow-400 mt-2">0</p>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <div class="glass-panel p-6 rounded-2xl h-fit">
            <h2 class="text-xl font-bold text-white mb-4 border-b border-gray-700 pb-2"><i class="fas fa-plus-circle text-blue-500"></i> Ø¥Ù†Ø´Ø§Ø¡ ÙƒÙˆØ¯ Ø¬Ø¯ÙŠØ¯</h2>
            
            <div class="space-y-4">
                <input id="stdName" type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨" class="w-full bg-slate-900 border border-slate-700 p-3 rounded-lg text-white focus:border-blue-500 outline-none">
                
                <select id="stdSection" class="w-full bg-slate-900 border border-slate-700 p-3 rounded-lg text-white">
                    <option value="Ø¹Ù„Ù…ÙŠ Ø¹Ù„ÙˆÙ…">ğŸ§¬ Ø¹Ù„Ù…ÙŠ Ø¹Ù„ÙˆÙ…</option>
                    <option value="Ø¹Ù„Ù…ÙŠ Ø±ÙŠØ§Ø¶Ø©">ğŸ“ Ø¹Ù„Ù…ÙŠ Ø±ÙŠØ§Ø¶Ø©</option>
                    <option value="Ø£Ø¯Ø¨ÙŠ">ğŸ“œ Ø£Ø¯Ø¨ÙŠ</option>
                    <option value="Ø£Ø²Ù‡Ø±">ğŸ•Œ Ø£Ø²Ù‡Ø±</option>
                </select>

                <div class="grid grid-cols-2 gap-2">
                    <select id="codeType" onchange="updatePrice()" class="w-full bg-slate-900 border border-slate-700 p-3 rounded-lg text-white">
                        <option value="month">ğŸ“… Ø´Ù‡Ø± ÙƒØ§Ù…Ù„</option>
                        <option value="trial">â³ ØªØ¬Ø±ÙŠØ¨ÙŠ (Ø³Ø§Ø¹Ø©)</option>
                    </select>
                    <div class="relative">
                        <input id="codePrice" type="number" value="100" class="w-full bg-slate-900 border border-slate-700 p-3 rounded-lg text-white text-center font-bold text-green-400">
                        <span class="absolute left-3 top-3 text-gray-500 text-sm">Ø¬.Ù…</span>
                    </div>
                </div>

                <button onclick="generateCode()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-bold transition shadow-lg shadow-blue-900/50">
                    Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙƒÙˆØ¯
                </button>

                <div id="newCodeArea" class="hidden mt-4 bg-green-900/30 border border-green-500/50 p-4 rounded-lg text-center">
                    <p class="text-green-400 text-sm mb-1">ØªÙ… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ù†Ø¬Ø§Ø­!</p>
                    <div id="codeDisplay" class="text-3xl font-mono font-bold text-white tracking-widest cursor-pointer hover:text-yellow-400" onclick="copyText(this.innerText)"></div>
                    <p class="text-xs text-gray-500 mt-1">Ø§Ø¶ØºØ· Ù„Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯</p>
                </div>
            </div>
        </div>

        <div class="glass-panel p-6 rounded-2xl lg:col-span-2">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-white"><i class="fas fa-users text-yellow-500"></i> Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†</h2>
                <input type="text" id="searchBox" onkeyup="filterTable()" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…..." class="bg-slate-900 border border-slate-700 px-4 py-2 rounded-lg text-sm text-white w-48 focus:w-64 transition-all">
            </div>

            <div class="overflow-x-auto">
                <table class="w-full text-sm text-right">
                    <thead class="bg-slate-800 text-gray-400 uppercase">
                        <tr>
                            <th class="p-3">Ø§Ù„Ø·Ø§Ù„Ø¨</th>
                            <th class="p-3">Ø§Ù„ÙƒÙˆØ¯</th>
                            <th class="p-3">Ø§Ù„Ù†ÙˆØ¹/Ø§Ù„Ø³Ø¹Ø±</th>
                            <th class="p-3">ÙŠÙ†ØªÙ‡ÙŠ ÙÙŠ</th>
                            <th class="p-3 text-center">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                        </tr>
                    </thead>
                    <tbody id="studentsTable" class="divide-y divide-slate-700">
                        </tbody>
                </table>
            </div>
        </div>

    </div>

    <script>
        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙØ§ÙŠØ±Ø¨ÙŠØ³ (ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¶Ø¹ Ø§Ù„ÙƒÙˆÙ†ÙÙŠØ¬ Ø§Ù„Ø¬Ø¯ÙŠØ¯)
        const firebaseConfig = {
            apiKey: "AIzaSyD1QB3qaFfkGYq0OWOEAr83V25NAPFwxzs",
            authDomain: "fullmark-2025.firebaseapp.com",
            databaseURL: "https://fullmark-2025-default-rtdb.firebaseio.com",
            projectId: "fullmark-2025",
            storageBucket: "fullmark-2025.firebasestorage.app",
            messagingSenderId: "963956202032",
            appId: "1:963956202032:web:4df914457d79b75dee2bf5"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¹Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ù†ÙˆØ¹
        function updatePrice() {
            const type = document.getElementById('codeType').value;
            const priceInput = document.getElementById('codePrice');
            if(type === 'trial') priceInput.value = 0;
            else priceInput.value = 100;
        }

        // 1. Ø¯Ø§Ù„Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙƒÙˆØ¯
        function generateCode() {
            const name = document.getElementById('stdName').value;
            const section = document.getElementById('stdSection').value;
            const type = document.getElementById('codeType').value;
            const price = parseInt(document.getElementById('codePrice').value) || 0;

            if(!name) return alert("Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨");

            const code = Math.floor(100000 + Math.random() * 900000).toString();
            
            // ØªØ­Ø¯ÙŠØ¯ Ù…Ø¯Ø© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©
            let duration = 0;
            if(type === 'trial') duration = 60 * 60 * 1000; // Ø³Ø§Ø¹Ø© ÙˆØ§Ø­Ø¯Ø©
            else duration = 30 * 24 * 60 * 60 * 1000; // 30 ÙŠÙˆÙ…

            const studentData = {
                studentName: name,
                section: section,
                type: type, // 'month' or 'trial'
                price: price, // Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹
                expiry: Date.now() + duration,
                createdAt: Date.now(),
                isBlocked: false,
                deviceId: null
            };

            db.ref('approvedStudents/' + code).set(studentData).then(() => {
                const area = document.getElementById('newCodeArea');
                area.classList.remove('hidden');
                document.getElementById('codeDisplay').innerText = code;
                document.getElementById('stdName').value = '';
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨ÙŠØªÙ… Ø¹Ø¨Ø± Ø§Ù„Ù€ listener ØªØ­Øª
            });
        }

        // 2. ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ¹Ø±Ø¶ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙˆØ§Ù„Ø¬Ø¯ÙˆÙ„
        db.ref('approvedStudents').on('value', (snapshot) => {
            const tbody = document.getElementById('studentsTable');
            tbody.innerHTML = ''; // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¬Ø¯ÙˆÙ„
            
            let totalStudents = 0;
            let totalMoney = 0;
            let soldCount = 0;

            if(snapshot.exists()) {
                const data = snapshot.val();
                
                // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù…ØµÙÙˆÙØ© ÙˆØ¹ÙƒØ³Ù‡Ø§ Ø¹Ø´Ø§Ù† Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙŠØ¸Ù‡Ø± ÙÙˆÙ‚
                const students = Object.entries(data).reverse();

                students.forEach(([code, std]) => {
                    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
                    totalStudents++;
                    if(std.price) totalMoney += parseInt(std.price);
                    if(std.type !== 'trial') soldCount++;

                    // Ø±Ø³Ù… Ø§Ù„ØµÙ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„
                    const row = document.createElement('tr');
                    const isExpired = Date.now() > std.expiry;
                    const dateStr = new Date(std.expiry).toLocaleDateString('ar-EG');
                    
                    row.className = "hover:bg-slate-800/50 transition";
                    row.innerHTML = `
                        <td class="p-3">
                            <div class="font-bold text-white">${std.studentName}</div>
                            <div class="text-xs text-gray-500">${std.section}</div>
                        </td>
                        <td class="p-3 font-mono text-yellow-500 cursor-pointer" onclick="copyText('${code}')">${code}</td>
                        <td class="p-3">
                            ${std.type === 'trial' 
                                ? '<span class="bg-gray-700 text-gray-300 px-2 py-1 rounded text-xs">ØªØ¬Ø±ÙŠØ¨ÙŠ</span>' 
                                : `<span class="bg-green-900 text-green-300 px-2 py-1 rounded text-xs">${std.price}Ø¬</span>`
                            }
                        </td>
                        <td class="p-3 ${isExpired ? 'text-red-500' : 'text-gray-300'}">
                            ${isExpired ? 'Ù…Ù†ØªÙ‡ÙŠ' : dateStr}
                        </td>
                        <td class="p-3 text-center space-x-2 space-x-reverse">
                            <button onclick="renewCode('${code}')" class="text-blue-400 hover:text-blue-300" title="ØªØ¬Ø¯ÙŠØ¯ Ø´Ù‡Ø±"><i class="fas fa-sync-alt"></i></button>
                            <button onclick="deleteCode('${code}')" class="text-red-400 hover:text-red-300" title="Ø­Ø°Ù"><i class="fas fa-trash"></i></button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒØ±ÙˆØª Ø§Ù„Ø¹Ù„ÙˆÙŠØ©
            document.getElementById('totalStudents').innerText = totalStudents;
            document.getElementById('totalRevenue').innerText = totalMoney.toLocaleString();
            document.getElementById('soldCodes').innerText = soldCount;
        });

        // 3. Ø¯Ø§Ù„Ø© ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ
        function renewCode(code) {
            if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø·Ø§Ù„Ø¨ Ù„Ù…Ø¯Ø© 30 ÙŠÙˆÙ… ÙˆØ¥Ø¶Ø§ÙØ© 100Ø¬ Ù„Ù„Ø£Ø±Ø¨Ø§Ø­ØŸ")) {
                db.ref('approvedStudents/' + code).once('value').then(snap => {
                    const data = snap.val();
                    const newExpiry = Date.now() + (30 * 24 * 60 * 60 * 1000);
                    const newPrice = (parseInt(data.price) || 0) + 100; // Ù†Ø²ÙˆØ¯ 100Ø¬ Ø¹Ù„Ù‰ Ø­Ø³Ø§Ø¨Ù‡
                    
                    db.ref('approvedStudents/' + code).update({
                        expiry: newExpiry,
                        price: newPrice,
                        type: 'month' // Ù„Ùˆ ÙƒØ§Ù† ØªØ¬Ø±ÙŠØ¨ÙŠ ÙŠØªØ­ÙˆÙ„ Ù„Ø´Ù‡Ø±
                    });
                });
            }
        }

        // 4. Ø¯Ø§Ù„Ø© Ø§Ù„Ø­Ø°Ù
        function deleteCode(code) {
            if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø·Ø§Ù„Ø¨ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ")) {
                db.ref('approvedStudents/' + code).remove();
            }
        }

        // 5. Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„
        function filterTable() {
            const filter = document.getElementById('searchBox').value.toLowerCase();
            const rows = document.getElementById('studentsTable').getElementsByTagName('tr');
            for (let row of rows) {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(filter) ? "" : "none";
            }
        }

        // Ù†Ø³Ø® Ø§Ù„Ù†ØµÙˆØµ
        function copyText(text) {
            navigator.clipboard.writeText(text).then(() => alert("ØªÙ… Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯: " + text));
        }
    </script>
</body>
</html>
